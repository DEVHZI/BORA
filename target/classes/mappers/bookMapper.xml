<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- bora_book -->
<!-- #{bk_num}, #{bk_detail_num}, #{id}, #{bk_year}, #{dk_month}, #{bk_budget} -->
<mapper namespace="com.bora.mapper.BookMapper">
	<resultMap type="com.bora.domain.report.BookDetailVO" id="detail">
		<id property="bk_detail_num" column="bk_detail_num"/>
		<id property="id" column="id"/>
		<id property="bk_day" column="bk_day"/>
		<id property="bk_iow" column="bk_iow"/>
		<id property="bk_group" column="bk_group"/>
		<id property="bk_category" column="bk_category"/>
		<id property="bk_money" column="bk_money"/>
		<id property="bk_memo" column="bk_memo"/>
	</resultMap>
	<resultMap type="com.bora.domain.report.BookVO" id="book">
		<id property="bk_num" column="bk_num" />
		<id property="id" column="id" />
		<id property="bk_year" column="bk_year" />
		<id property="bk_month" column="bk_month" />
		<id property="bk_budget" column="bk_budget" />
		<collection property="detail" resultMap="detail" />
	</resultMap>
	
	<parameterMap type="com.bora.domain.report.BookVO" id="book">
		<parameter property="bk_num" />
		<parameter property="id" />
		<parameter property="bk_year" />
		<parameter property="bk_month" />
		<parameter property="bk_budget" />
	</parameterMap>

	<!-- 월 별 가계부 작성 -->
	<insert id="writeBook" parameterType="hashmap">
		insert bora_book (id, bk_year, bk_month, bk_budget, bk_detail_num)
		values(#{book.id}, #{book.bk_year}, #{book.bk_month}, #{book.bk_budget}, #{bk_detail_num})
	</insert>
	
	<!-- 예산 설정 -->
	<update id="setBudget">
		update bora_book 
		where id=#{loginID} and bk_year=#{bk_year} and bk_month=#{bk_month}
	</update>	
	
	<!-- 가계부 전체 글 개수 조회 -->
	<select id="getBookCnt" resultType="Integer">
		select count(*) from bora_book
		where id=#{id}
	</select>
	
	<!-- 특정 달 가계부 글 개수 조회 -->
	<select id="getBookMonthCnt" resultType="Integer">
		select count(*) from bora_book
		where bk_year=#{bk_year}, bk_month=#{bk_month}
	</select>
	
	<!-- 모든 가계부 목록 조회 -->
	<select id="getBookListAll" resultType="com.bora.domain.report.BookVO"
			resultMap="book">
		select * 
		from bora_book b join bora_book_detail d
		on b.bk_detail_num = d.bk_detail_num
		where b.id=#{loginID}
		order by b.bk_num desc, d.bk_detail_num desc
	</select>
	
	<!-- 페이징 처리된 가계부 목록 조회 -->
	<select id="getBookListPage" resultType="com.bora.domain.report.BookVO" 
		resultMap="book">
		select * 
		from bora_book b join bora_book_detail d
		on b.bk_detail_num = d.bk_detail_num
		where b.id=#{id}
		order by b.bk_num desc, d.bk_detail_num desc
		limit #{pm.pageStart}, #{pm.vo.perPageNum}
	</select>
	
	<!-- 특정 달 페이징 처리된 가계부 목록 조회 -->
	<select id="getBookMonthListPage" resultType="com.bora.domain.report.BookVO">
		select * 
		from bora_book b join bora_book_detail d
		on b.bk_detail_num = d.bk_detail_num
		where bk_year=#{bk_year}, bk_month=#{bk_month}
		order by bk_num desc, bk_regdate desc
		limit #{pageStart}, #{perPageNum}
	</select>
	
	<!-- 특정 가계부 내역 조회 -->
	<select id="getBook" resultType="com.bora.domain.report.BookVO" resultMap="book">
		select * from bora_book b join bora_book_detail d
		on b.bk_detail_num = d.bk_detail_num
		where b.bk_num=#{bk_num} and b.id=#{id}
	</select>
	
	<!-- 가계부 수정 -->
	<update id="updateBook">
		update bora_book
		set bk_year=#{bk_year}, bk_month=#{bk_month}, bk_budget=#{bk_budget}
		where bk_num=#{bk_num}
	</update>
	
	<!-- 가계부 삭제 -->
	<delete id="deleteBook">
		delete from bora_book
		where bk_num=#{bk_num} 
			  and id=#{id}
	</delete>
	
</mapper>